# 予約状況確認画面 基本設計書

作成日: 2025-01-27  
バージョン: v1.2  
対象: 音楽スタジオ予約システム MVP

---

## 1. 概要

### 1.1 目的
予約状況確認画面は、スタジオの予約状況を視覚的に確認できるカレンダー形式の画面です。学生・講師・TAが利用日・時間枠・スタジオ別の予約状況を一覧で確認し、空き状況を把握できるようにします。

### 1.2 対象ユーザー
- **学生**: 自分の予約状況確認、空き枠確認
- **講師**: 授業・イベント予約の状況確認
- **TA**: 受付業務での当日予約状況確認

### 1.3 主要機能
- 日付指定による予約状況表示
- スタジオ別・時間枠別の予約状態表示（カード形式）
- 予約詳細情報の表示（予約種類、イベント名等）
- 猶予時間経過の視覚的表示
- 空き枠クリックによる予約ダイアログ表示
- モバイルファースト対応のレスポンシブデザイン

---

## 2. 画面仕様

### 2.1 画面構成（モバイル版）

```
┌──────────────────────────────────┐
│      予約状況                     │
│                                  │
│  📅 [日付選択: 2025/10/09]      │
├──────────────────────────────────┤
│                                  │
│  ┌────────────────────────────┐ │
│  │ Studio A              ▾    │ │
│  ├────────────────────────────┤ │
│  │ P1 (09:00-10:30)  ○空     │ │
│  │ P2 (10:40-12:10)  ●予約済  │ │
│  │ P3 (13:00-14:30)  ○空     │ │
│  │ P4 (14:40-16:10)  ○空     │ │
│  │ P5 (16:20-17:50)  ○空     │ │
│  └────────────────────────────┘ │
│                                  │
│  ┌────────────────────────────┐ │
│  │ Studio B              ▾    │ │
│  ├────────────────────────────┤ │
│  │ （展開時に表示）            │ │
│  └────────────────────────────┘ │
│                                  │
├──────────────────────────────────┤
│      [予約する]                  │
└──────────────────────────────────┘
```

### 2.1.2 予約ダイアログ

```
┌──────────────────────────────────┐
│  予約内容の確認                  │
├──────────────────────────────────┤
│  日付: 2025/10/09 (水)          │
│  スタジオ: Studio A              │
│  限: P1（09:00 - 10:30）        │
├──────────────────────────────────┤
│  利用目的（任意）                │
│  ┌────────────────────────────┐ │
│  │                            │ │
│  └────────────────────────────┘ │
├──────────────────────────────────┤
│  ・開始5分前に入室してください   │
│  ・無断キャンセルは制限対象      │
├──────────────────────────────────┤
│  [キャンセル] [この内容で予約]   │
└──────────────────────────────────┘
```

### 2.2 画面要素

#### 2.2.1 ヘッダー部
- **画面タイトル**: "予約状況"
- **日付選択バー**: 
  - カレンダーアイコン（📅）
  - `DatePicker` コンポーネント（カスタムコンポーネント）
  - 今日から1週間後までの日付選択が可能

#### 2.2.2 スタジオカード部
- **カード形式**: スタジオごとにカード表示（折りたたみ可能）
- **スタジオヘッダー**: 
  - スタジオ名
  - 展開/折りたたみアイコン（▾）
- **時間枠リスト**: 
  - 期間ID（P1〜P5）
  - 時間範囲（例: 09:00-10:30）
  - 予約状態バッジ
  - 予約種類・イベント名（予約済みの場合）
  - 猶予時間経過表示（該当する場合）

#### 2.2.3 予約ダイアログ
- **ダイアログヘッダー**: "予約内容の確認"
- **予約情報表示**:
  - 日付（曜日付き）
  - スタジオ名
  - 限（時間範囲付き）
- **利用目的入力**: テキストエリア（任意）
- **注意事項**: 静的テキスト表示
- **アクションボタン**:
  - キャンセルボタン
  - 予約ボタン（送信中は無効化）

#### 2.2.4 フッター部
- **予約ボタン**: メイン予約フローへ遷移（将来の拡張用）

### 2.3 セル表示パターン

| フロントエンド状態 | バックエンド状態 | 表示 | 色 | クリック可否 | 説明 |
|-------------------|-----------------|------|-----|-------------|------|
| available | 空 | 空 | グレー背景・グレー文字 | ○ | 予約可能な状態。クリックで予約ダイアログ表示 |
| booked | 予約済み、予約確定 | 予約済 | 黄色背景・茶色文字 | × | 予約済み・予約確定状態 |
| in_use | 使用中 | 使用中 | 緑背景・緑文字 | × | 現在使用中（Check-in済み） |
| canceled | 予約キャンセル | キャンセル | 赤背景・赤文字 | × | キャンセル済み |

#### 2.3.1 追加表示
- **猶予時間経過**: 予約開始から10分経過した場合、別途「10分経過」バッジを表示（赤背景）
- **予約種類**: 予約済みの場合、「学生レンタル」「授業レンタル」「イベント予約」を小さく表示
- **イベント名**: イベント予約の場合、イベント名を青文字で表示

---

## 3. データ仕様

### 3.1 API仕様

#### 3.1.1 エンドポイント
```
GET /api/booking-calendar?date={YYYY-MM-DD}&studioId={studioId}
```

#### 3.1.2 リクエストパラメータ
- `date`: 確認対象日（必須、YYYY-MM-DD形式）
- `studioId`: スタジオID（任意、指定時は該当スタジオのみ）

#### 3.1.3 レスポンス形式
```json
{
  "usageDate": "2025-01-27",
  "periodOrder": ["P1", "P2", "P3", "P4", "P5"],
  "rows": [
    {
      "studioId": "Aスタ",
      "studioName": "Studio A",
      "slots": [
        {
          "periodId": "P1",
          "status": "空",
          "bookingId": null,
          "reservationType": null,
          "eventName": null,
          "graceExpired": false,
          "startTime": "09:00",
          "endTime": "10:30"
        },
        {
          "periodId": "P2",
          "status": "予約確定",
          "bookingId": "booking-123",
          "reservationType": "学生レンタル",
          "eventName": null,
          "graceExpired": false,
          "startTime": "10:40",
          "endTime": "12:10"
        },
        {
          "periodId": "P3",
          "status": "予約済み",
          "bookingId": "booking-456",
          "reservationType": "イベント予約",
          "eventName": "新入生歓迎ライブ",
          "graceExpired": false,
          "startTime": "13:00",
          "endTime": "14:30"
        }
      ]
    }
  ]
}
```

#### 3.1.4 フィールド説明
- `usageDate`: 利用日（YYYY-MM-DD形式）
- `periodOrder`: 期間の表示順序
- `rows`: スタジオごとの予約状況
  - `studioId`: スタジオID
  - `studioName`: スタジオ表示名
  - `slots`: 時間枠ごとの予約状況
    - `periodId`: 期間ID（P1〜P5）
    - `status`: 予約状態（"空", "予約済み", "予約確定", "使用中", "予約キャンセル"）
    - `bookingId`: 予約ID（予約がある場合）
    - `reservationType`: 予約種類（"学生レンタル", "授業レンタル", "イベント予約"）
    - `eventName`: イベント名（イベント予約の場合）
    - `graceExpired`: 猶予時間経過フラグ
    - `startTime`: 開始時刻（HH:mm形式）
    - `endTime`: 終了時刻（HH:mm形式）

### 3.2 データマッピング

#### 3.2.1 状態マッピング（バックエンド → フロントエンド）
| バックエンドAPI状態 | フロントエンド内部状態 | 画面表示 | 説明 |
|--------------------|----------------------|---------|------|
| 空 | available | 空 | 予約なし |
| 予約済み | booked | 予約済 | 予約済み状態 |
| 予約確定 | booked | 予約済 | 予約確定状態 |
| 使用中 | in_use | 使用中 | Check-in済み |
| 予約キャンセル | canceled | キャンセル | キャンセル済み |

**注**: フロントエンドでは「予約済み」と「予約確定」を同じ `booked` 状態として扱い、画面上は「予約済」と表示します。

#### 3.2.2 猶予時間判定
- `graceExpired`: 予約開始から10分経過フラグ
- `graceMinutes`: 猶予時間（10分固定）

---

## 4. ビジネスルール

### 4.1 表示ルール
1. **日付範囲**: 今日から1週間後までの日付を表示可能
2. **時間枠**: PeriodDefinitionで定義された時間枠を表示
3. **スタジオ**: システムに登録された全スタジオを表示
4. **状態更新**: リアルタイム更新は行わず、手動再読込で更新
5. **予約制限**: 過去の日付および1週間後以降の日付は予約不可

### 4.2 権限制御
- **学生**: 全予約状況の閲覧可能
- **講師**: 全予約状況の閲覧可能
- **TA**: 全予約状況の閲覧可能、猶予時間経過の強調表示

### 4.3 データ整合性
- **重複予約**: 同一スタジオ×日付×時間枠で重複予約は表示されない
- **状態整合**: BookingStatusとStudioSlotStatusの整合性を保持
- **時間整合**: PeriodDefinitionの時間設定に基づく表示
- **日付制限**: バックエンドとフロントエンドの両方で1週間後までの制限を適用

---

## 5. 技術仕様

### 5.1 フロントエンド技術
- **フレームワーク**: Vue 3 + TypeScript
- **状態管理**: Pinia Store
- **UI**: Tailwind CSS
- **API通信**: Fetch API

### 5.2 バックエンド技術
- **フレームワーク**: Play Framework (Scala)
- **アーキテクチャ**: DDD (Domain-Driven Design)
- **API**: RESTful API
- **ログ**: 構造化ログ（LoggerUtil）

### 5.3 コンポーネント構成（Atomic Design）

```
SchedulePage.vue (Pages)
├── DatePicker.vue (Molecules)
│   └── カスタム日付選択コンポーネント
├── StudioCard.vue (Organisms)
│   └── PeriodCard.vue (Molecules)
│       └── SlotCell.vue (Molecules)
├── ReservationDialog.vue (Organisms)
│   ├── ModalSheet.vue (Molecules)
│   └── Row.vue (Atoms)
└── エラー・ローディング表示

API層
├── bookingCalendarApi.ts
│   └── fetchBookingCalendar()
└── apiTransformers.ts
    └── transformBookingCalendarToStudios()

型定義 (types.ts)
├── Studio
├── PeriodSlot
├── PeriodStatus
├── BookingCalendarView
├── StudioRow
└── SlotView
```

#### 5.3.1 主要コンポーネント説明

**SchedulePage.vue**
- 予約状況確認画面のメインページ
- 日付選択、データ取得、エラーハンドリングを管理
- `StudioCard` を v-for でレンダリング
- `ReservationDialog` の表示制御

**StudioCard.vue**
- スタジオごとのカード表示
- 横スクロール可能な期間リスト
- 期間クリック時に親へイベント発火

**PeriodCard.vue**
- 個別の期間カード
- 予約状態に応じたバッジ表示
- クリック可能な空き枠の視覚的フィードバック

**ReservationDialog.vue**
- 予約確認ダイアログ
- モーダルシート形式
- 利用目的入力、注意事項表示
- 予約確定処理

**DatePicker.vue**
- カスタム日付選択コンポーネント
- 今日から1週間後までの制限
- カレンダーアイコン付き

---

## 6. 画面遷移

### 6.1 遷移元
- **メインメニュー**: 予約状況確認メニューから遷移
- **予約作成画面**: 空き状況確認後、予約作成画面へ遷移
- **受付画面**: TA向け受付画面から遷移

### 6.2 遷移先
- **予約ダイアログ**: 空き枠をクリックして予約確認ダイアログ表示（モーダル）
- **予約完了**: 予約確定後、同画面でデータ再取得
- **受付画面**: TA向けの受付業務画面（将来実装）

### 6.3 画面内遷移フロー
1. ユーザーが日付を選択
2. 予約状況データを取得して表示
3. 空き枠（available状態）をクリック
4. `ReservationDialog` がモーダル表示される
5. 利用目的を入力（任意）
6. 「この内容で予約」ボタンをクリック
7. 予約API呼び出し（TODO: 実装予定）
8. 成功時: ダイアログを閉じて予約状況を再取得
9. エラー時: エラーメッセージを表示

---

## 7. エラーハンドリング

### 7.1 エラーケース
1. **日付形式エラー**: 無効な日付形式の場合
2. **日付範囲エラー**: 過去の日付または1週間後以降の日付を選択した場合
3. **API通信エラー**: ネットワークエラー、サーバーエラー
4. **データ不整合**: 予約データの整合性エラー

### 7.2 エラー表示
- **ローディング状態**: "読み込み中..." 表示
- **エラー状態**: "エラー: {エラーメッセージ}" 表示
- **空データ**: 正常にデータが取得できたが予約がない場合

---

## 8. パフォーマンス要件

### 8.1 レスポンス時間
- **画面表示**: 3秒以内
- **データ取得**: 2秒以内
- **再読込**: 1秒以内

### 8.2 データ量
- **1日分のデータ**: 最大50スタジオ × 5時間枠 = 250セル
- **JSONサイズ**: 10KB以下
- **メモリ使用量**: 1MB以下

---

## 9. セキュリティ要件

### 9.1 認証・認可
- **認証**: セッション認証（credentials: include）
- **認可**: ロールベースアクセス制御
- **CSRF**: CSRFトークンによる保護

### 9.2 データ保護
- **個人情報**: 学生番号等の個人情報は最小限表示
- **ログ**: アクセスログの記録
- **監査**: 操作ログの保持

---

## 10. テスト仕様

### 10.1 単体テスト
- **コンポーネントテスト**: Vue Test Utils
- **APIテスト**: Play Framework Test
- **状態管理テスト**: Pinia Store Test

### 10.2 結合テスト
- **E2Eテスト**: Playwright
- **API結合テスト**: ScalaTest
- **画面遷移テスト**: Vue Router Test

### 10.3 受け入れテスト
```gherkin
Given 予約状況確認画面が表示されている
When 日付を選択して再読込ボタンをクリックする
Then 選択した日付の予約状況が表示される

Given 予約済みのセルが表示されている
When そのセルをクリックする
Then 予約詳細画面に遷移する

Given 空き枠のセルが表示されている
When そのセルをクリックする
Then 予約作成画面に遷移する

Given 過去の日付を選択しようとする
When 日付入力フィールドに過去の日付を入力する
Then 日付選択が無効化される

Given 1週間後以降の日付を選択しようとする
When 日付入力フィールドに1週間後以降の日付を入力する
Then 日付選択が無効化される
```

---

## 11. 今後の拡張予定

### 11.1 機能拡張
- **リアルタイム更新**: WebSocketによる自動更新
- **フィルタリング**: 予約種類別フィルタ
- **検索機能**: 学生番号・イベント名での検索
- **エクスポート**: CSV/PDF出力機能

### 11.2 UI改善
- ~~**レスポンシブ対応**: モバイル表示最適化~~ ✅ 実装済み（モバイルファースト）
- **アクセシビリティ**: WCAG 2.1準拠（一部実装済み: role属性、aria-label等）
- **ダークモード**: テーマ切り替え機能（CSS変数で一部対応済み）

### 11.3 実装済み機能
- ✅ モバイルファーストのカード形式UI
- ✅ 横スクロール可能な期間リスト
- ✅ 予約ダイアログ（ReservationDialog）
- ✅ 日付選択制限（今日から1週間後まで）
- ✅ ローディング・エラー状態の表示
- ✅ 期間時刻の表示（startTime, endTime）
- ✅ イベント名の表示
- ✅ 猶予時間経過の表示

### 11.4 未実装・TODO
- ⏳ 予約API呼び出し（現在はアラート表示のみ）
- ⏳ 予約詳細画面への遷移
- ⏳ リアルタイム更新（WebSocket）
- ⏳ フィルタリング機能
- ⏳ 検索機能
- ⏳ エクスポート機能

---

## 12. 関連ドキュメント

- [要件定義.md](./要件定義.md)
- [ユビキタス言語帳.md](./ユビキタス言語帳.md)
- [ログ仕様書.md](./ログ仕様書.md)
- [環境構築手順.md](./環境構築手順.md)

---

## 13. 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|------------|------|----------|--------|
| v1.0 | 2025-01-27 | 初版作成 | AI Assistant |
| v1.1 | 2025-01-27 | 1週間後までの予約制限を追加 | AI Assistant |
| v1.2 | 2025-10-09 | 現在の実装に合わせて全面改訂<br>- コンポーネント名を SchedulePage に変更<br>- カード形式UIに変更<br>- ReservationDialog の追加<br>- API レスポンスに期間時刻情報を追加<br>- Atomic Design 構成の明記<br>- 実装済み機能の明記 | AI Assistant |

---

**注記**: 本設計書は音楽スタジオ予約システムMVPの予約状況確認画面に関する基本設計書です。実装時はユビキタス言語帳の用語定義に従って開発を進めてください。
