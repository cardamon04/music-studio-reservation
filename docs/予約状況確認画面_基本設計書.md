# 予約状況確認画面 基本設計書

作成日: 2025-01-27  
バージョン: v1.0  
対象: 音楽スタジオ予約システム MVP

---

## 1. 概要

### 1.1 目的
予約状況確認画面は、スタジオの予約状況を視覚的に確認できるカレンダー形式の画面です。学生・講師・TAが利用日・時間枠・スタジオ別の予約状況を一覧で確認し、空き状況を把握できるようにします。

### 1.2 対象ユーザー
- **学生**: 自分の予約状況確認、空き枠確認
- **講師**: 授業・イベント予約の状況確認
- **TA**: 受付業務での当日予約状況確認

### 1.3 主要機能
- 日付指定による予約状況表示
- スタジオ別・時間枠別の予約状態表示
- 予約詳細情報の表示（予約種類、イベント名等）
- 猶予時間経過の視覚的表示

---

## 2. 画面仕様

### 2.1 画面構成

```
┌─────────────────────────────────────────────────────────────┐
│ 予約状況確認画面                                                │
├─────────────────────────────────────────────────────────────┤
│ [日付選択] [再読込] 予約状況                                    │
├─────────────────────────────────────────────────────────────┤
│ スタジオ │ P1 │ P2 │ P3 │ P4 │ P5 │                        │
├─────────┼────┼────┼────┼────┼────┤                        │
│ Aスタ   │ ○空 │ ●予約済 │ ○空 │ ○空 │ ○空 │                │
│ Bスタ   │ ○空 │ ○空 │ ●使用中 │ ○空 │ ○空 │                │
│ Cスタ   │ ○空 │ ○空 │ ○空 │ ○空 │ ○空 │                │
└─────────┴────┴────┴────┴────┴────┘                        │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 画面要素

#### 2.2.1 ヘッダー部
- **日付選択**: HTML5のdate input要素
- **再読込ボタン**: 現在選択中の日付でデータを再取得
- **画面タイトル**: "予約状況"

#### 2.2.2 カレンダー部
- **テーブル形式**: スタジオ（行）× 時間枠（列）のマトリックス
- **スタジオ列**: スタジオ名（Aスタ、Bスタ等）
- **時間枠列**: P1〜P5の各時間枠
- **セル表示**: 各スタジオ×時間枠の予約状態

### 2.3 セル表示パターン

| 状態 | 表示 | 色 | 説明 |
|------|------|-----|------|
| 空 | ○ 空 | 緑背景 | 予約可能な状態 |
| 予約済み | ● 予約済 | グレー背景 | 予約済み・予約確定状態 |
| 使用中 | ● 使用中 | 青背景 | 現在使用中（Check-in済み） |
| キャンセル | ● キャンセル | 赤背景 | キャンセル済み |
| 10分経過 | ● 10分経過 | オレンジ背景 | 猶予時間経過（TA向け） |

---

## 3. データ仕様

### 3.1 API仕様

#### 3.1.1 エンドポイント
```
GET /api/booking-calendar?date={YYYY-MM-DD}&studioId={studioId}
```

#### 3.1.2 リクエストパラメータ
- `date`: 確認対象日（必須、YYYY-MM-DD形式）
- `studioId`: スタジオID（任意、指定時は該当スタジオのみ）

#### 3.1.3 レスポンス形式
```json
{
  "date": "2025-01-27",
  "periodOrder": ["P1", "P2", "P3", "P4", "P5"],
  "rows": [
    {
      "studioId": "Aスタ",
      "slots": [
        {
          "periodId": "P1",
          "status": "空",
          "bookingId": null,
          "reservationType": null,
          "eventName": null,
          "graceExpired": false
        },
        {
          "periodId": "P2",
          "status": "予約確定",
          "bookingId": "booking-123",
          "reservationType": "学生レンタル",
          "eventName": null,
          "graceExpired": false
        }
      ]
    }
  ]
}
```

### 3.2 データマッピング

#### 3.2.1 状態マッピング（バックエンド → フロントエンド）
| バックエンド状態 | フロントエンド表示 | 説明 |
|------------------|-------------------|------|
| Empty | 空 | 予約なし |
| Reserved | 予約済 | 予約済み状態 |
| Confirmed | 予約済 | 予約確定状態 |
| InUse | 使用中 | Check-in済み |
| Canceled | キャンセル | キャンセル済み |

#### 3.2.2 猶予時間判定
- `graceExpired`: 予約開始から10分経過フラグ
- `graceMinutes`: 猶予時間（10分固定）

---

## 4. ビジネスルール

### 4.1 表示ルール
1. **日付範囲**: 今日から1週間後までの日付を表示可能
2. **時間枠**: PeriodDefinitionで定義された時間枠を表示
3. **スタジオ**: システムに登録された全スタジオを表示
4. **状態更新**: リアルタイム更新は行わず、手動再読込で更新
5. **予約制限**: 過去の日付および1週間後以降の日付は予約不可

### 4.2 権限制御
- **学生**: 全予約状況の閲覧可能
- **講師**: 全予約状況の閲覧可能
- **TA**: 全予約状況の閲覧可能、猶予時間経過の強調表示

### 4.3 データ整合性
- **重複予約**: 同一スタジオ×日付×時間枠で重複予約は表示されない
- **状態整合**: BookingStatusとStudioSlotStatusの整合性を保持
- **時間整合**: PeriodDefinitionの時間設定に基づく表示
- **日付制限**: バックエンドとフロントエンドの両方で1週間後までの制限を適用

---

## 5. 技術仕様

### 5.1 フロントエンド技術
- **フレームワーク**: Vue 3 + TypeScript
- **状態管理**: Pinia Store
- **UI**: Tailwind CSS
- **API通信**: Fetch API

### 5.2 バックエンド技術
- **フレームワーク**: Play Framework (Scala)
- **アーキテクチャ**: DDD (Domain-Driven Design)
- **API**: RESTful API
- **ログ**: 構造化ログ（LoggerUtil）

### 5.3 コンポーネント構成
```
BookingStatusPage.vue
├── 日付選択コンポーネント
├── 再読込ボタン
├── カレンダーテーブル
│   ├── ヘッダー行（時間枠）
│   └── データ行（スタジオ別）
└── エラー表示
```

---

## 6. 画面遷移

### 6.1 遷移元
- **メインメニュー**: 予約状況確認メニューから遷移
- **予約作成画面**: 空き状況確認後、予約作成画面へ遷移
- **受付画面**: TA向け受付画面から遷移

### 6.2 遷移先
- **予約作成画面**: 空き枠をクリックして予約作成
- **予約詳細画面**: 予約済みセルをクリックして詳細表示
- **受付画面**: TA向けの受付業務画面

---

## 7. エラーハンドリング

### 7.1 エラーケース
1. **日付形式エラー**: 無効な日付形式の場合
2. **日付範囲エラー**: 過去の日付または1週間後以降の日付を選択した場合
3. **API通信エラー**: ネットワークエラー、サーバーエラー
4. **データ不整合**: 予約データの整合性エラー

### 7.2 エラー表示
- **ローディング状態**: "読み込み中..." 表示
- **エラー状態**: "エラー: {エラーメッセージ}" 表示
- **空データ**: 正常にデータが取得できたが予約がない場合

---

## 8. パフォーマンス要件

### 8.1 レスポンス時間
- **画面表示**: 3秒以内
- **データ取得**: 2秒以内
- **再読込**: 1秒以内

### 8.2 データ量
- **1日分のデータ**: 最大50スタジオ × 5時間枠 = 250セル
- **JSONサイズ**: 10KB以下
- **メモリ使用量**: 1MB以下

---

## 9. セキュリティ要件

### 9.1 認証・認可
- **認証**: セッション認証（credentials: include）
- **認可**: ロールベースアクセス制御
- **CSRF**: CSRFトークンによる保護

### 9.2 データ保護
- **個人情報**: 学生番号等の個人情報は最小限表示
- **ログ**: アクセスログの記録
- **監査**: 操作ログの保持

---

## 10. テスト仕様

### 10.1 単体テスト
- **コンポーネントテスト**: Vue Test Utils
- **APIテスト**: Play Framework Test
- **状態管理テスト**: Pinia Store Test

### 10.2 結合テスト
- **E2Eテスト**: Playwright
- **API結合テスト**: ScalaTest
- **画面遷移テスト**: Vue Router Test

### 10.3 受け入れテスト
```gherkin
Given 予約状況確認画面が表示されている
When 日付を選択して再読込ボタンをクリックする
Then 選択した日付の予約状況が表示される

Given 予約済みのセルが表示されている
When そのセルをクリックする
Then 予約詳細画面に遷移する

Given 空き枠のセルが表示されている
When そのセルをクリックする
Then 予約作成画面に遷移する

Given 過去の日付を選択しようとする
When 日付入力フィールドに過去の日付を入力する
Then 日付選択が無効化される

Given 1週間後以降の日付を選択しようとする
When 日付入力フィールドに1週間後以降の日付を入力する
Then 日付選択が無効化される
```

---

## 11. 今後の拡張予定

### 11.1 機能拡張
- **リアルタイム更新**: WebSocketによる自動更新
- **フィルタリング**: 予約種類別フィルタ
- **検索機能**: 学生番号・イベント名での検索
- **エクスポート**: CSV/PDF出力機能

### 11.2 UI改善
- **レスポンシブ対応**: モバイル表示最適化
- **アクセシビリティ**: WCAG 2.1準拠
- **ダークモード**: テーマ切り替え機能

---

## 12. 関連ドキュメント

- [要件定義.md](./要件定義.md)
- [ユビキタス言語帳.md](./ユビキタス言語帳.md)
- [ログ仕様書.md](./ログ仕様書.md)
- [環境構築手順.md](./環境構築手順.md)

---

## 13. 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|------------|------|----------|--------|
| v1.0 | 2025-01-27 | 初版作成 | AI Assistant |
| v1.1 | 2025-01-27 | 1週間後までの予約制限を追加 | AI Assistant |

---

**注記**: 本設計書は音楽スタジオ予約システムMVPの予約状況確認画面に関する基本設計書です。実装時はユビキタス言語帳の用語定義に従って開発を進めてください。
