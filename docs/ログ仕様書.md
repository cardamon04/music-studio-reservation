# ログ仕様書

## 概要

Music Studio Reservation Systemのログ出力仕様について説明します。

## ログファイル

### ファイル名

- **メインログファイル**: `studio-backend.log`
- **ローテーション済みファイル**: `studio-backend.1.log`, `studio-backend.2.log`, ...

### ファイル場所

```text
studio-backend/logs/
├── studio-backend.log        # 現在のログファイル
├── studio-backend.1.log      # 1番目のローテーション済みファイル
├── studio-backend.2.log      # 2番目のローテーション済みファイル
└── ...
```

## ログローテーション

### ローテーション方式

- **サイズベースローテーション**
- **トリガー**: ファイルサイズが5MBを超えた場合
- **保持数**: 最大10ファイルまで保持
- **総容量**: 最大50MB（5MB × 10ファイル）

### ローテーション動作

1. `studio-backend.log`が5MBを超える
2. `studio-backend.log` → `studio-backend.1.log`にリネーム
3. 新しい`studio-backend.log`を作成
4. 次に5MBを超えたら`studio-backend.1.log` → `studio-backend.2.log`にリネーム
5. 最大10ファイルまで保持、それ以上は古いファイルを削除

## ログレベル

### 設定

- **root**: INFO
- **play**: INFO
- **application**: DEBUG
- **utils**: DEBUG

### ログレベル説明

- **ERROR**: エラーが発生した場合
- **WARN**: 警告レベルの情報
- **INFO**: 一般的な情報
- **DEBUG**: デバッグ情報

## ログフォーマット

### フォーマット文字列

```text
%d{yyyy-MM-dd HH:mm:ss} %-5level %cyan(%logger{36}) %magenta(%X{pekkoSource}) %msg%n
```

### フォーマット要素

- `%d{yyyy-MM-dd HH:mm:ss}`: タイムスタンプ
- `%-5level`: ログレベル（INFO、WARN、ERROR、DEBUG）
- `%cyan(%logger{36})`: ロガー名（36文字まで）
- `%magenta(%X{pekkoSource})`: Pekkoソース情報
- `%msg`: ログメッセージ
- `%n`: 改行

### 出力例

```text
2025-10-04 09:40:00 INFO  utils.LoggerUtil [I001] 予約が正常に作成されました: booking-123
2025-10-04 09:40:01 ERROR utils.LoggerUtil [E001] 予約作成に失敗しました: 重複予約エラー
2025-10-04 09:40:02 DEBUG utils.LoggerUtil [D001] 予約作成リクエストを受信: {"studioId":"A"...}
```

## メッセージID管理

### メッセージファイル

- **ファイル**: `conf/messages`
- **管理方式**: メッセージIDで管理

### メッセージID分類

- **E001-E010**: エラーメッセージ
- **I001-I012**: 情報メッセージ
- **W001-W010**: 警告メッセージ
- **D001-D010**: デバッグメッセージ

### メッセージ例

```text
# エラーメッセージ (E)
E001 = 予約作成に失敗しました: {0}
E002 = 無効な日付形式です: {0}

# 情報メッセージ (I)
I001 = 予約が正常に作成されました: {0}
I002 = 予約カレンダーを取得しました: {0}
I011 = ビジネスログ: {0}
I012 = パフォーマンスログ: {0}

# 警告メッセージ (W)
W001 = 予約の猶予時間が経過しました: {0}
W002 = 在庫が少なくなっています: {0}

# デバッグメッセージ (D)
D001 = 予約作成リクエストを受信: {0}
D002 = 予約データを検証中: {0}
```

## LoggerUtil使用方法

### 基本的な使用方法

```scala
// 情報ログ
loggerUtil.info("I001", bookingId)

// エラーログ
loggerUtil.error("E001", errorMessage)

// 警告ログ
loggerUtil.warn("W001", warningMessage)

// デバッグログ
loggerUtil.debug("D001", debugInfo)
```

### リクエスト情報付きログ

```scala
loggerUtil.logWithRequest("info", "I007", request, "予約作成")
```

### 例外情報付きエラーログ

```scala
loggerUtil.errorWithException("E009", exception, "詳細情報")
```

### ビジネスログ

```scala
loggerUtil.businessLog("I011", "予約作成", bookingId, "スタジオ: A")
```

### パフォーマンスログ

```scala
loggerUtil.performance("I012", "予約作成", 150L, "データベース処理")
```

### 特殊ログ（IDなし）

すべてのログはメッセージIDを使用します。IDなしのログは出力されません。

## ログ監視・運用

### ログファイル監視

- ログファイルのサイズを定期的に確認
- ローテーションが正常に動作しているか確認
- エラーログの発生頻度を監視

### ログ分析

- エラーパターンの分析
- パフォーマンスログの分析
- ビジネスログの分析

### ログ保持期間

- **本番環境**: 30日間
- **開発環境**: 7日間
- **テスト環境**: 3日間

## トラブルシューティング

### よくある問題

#### ログが出力されない

- ログレベル設定を確認
- ログファイルの書き込み権限を確認
- ディスク容量を確認

#### ローテーションが動作しない

- ファイルサイズ制限を確認
- ログファイルの権限を確認
- ログバック設定を確認

#### メッセージIDが見つからない

- `conf/messages`ファイルの内容を確認
- メッセージIDの形式を確認
- 国際化設定を確認

### ログ設定の確認方法

```bash
# ログファイルの確認
ls -la studio-backend/logs/

# ログファイルのサイズ確認
du -h studio-backend/logs/studio-backend.log

# ログの内容確認
tail -f studio-backend/logs/studio-backend.log
```

## 今後の拡張予定

### 機能追加予定

- ログの構造化（JSON形式）
- ログの外部送信（ELK Stack等）
- ログの暗号化
- ログの圧縮

### 監視機能追加予定

- ログアラート機能
- ログダッシュボード
- ログメトリクス収集

## 更新履歴

| 日付 | バージョン | 更新内容 | 更新者 |
|---|---|---|---|
| 2025-10-04 | v1.0 | 初期版作成 | AI Assistant |
| 2025-10-04 | v1.1 | ログ出力例セクション削除 | AI Assistant |
| 2025-10-04 | v1.3 | すべてのログにメッセージIDを必須化、IDなしログを廃止 | AI Assistant |
| 2025-10-04 | v1.4 | ログレベル表示を簡素化（%highlight削除） | AI Assistant |
| 2025-10-05 | v1.5 | Markdown警告をすべて修正 | AI Assistant |